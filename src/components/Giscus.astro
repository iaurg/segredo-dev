---
// Giscus - A comments system powered by GitHub Discussions
// Configure at: https://giscus.app
---

<section class="giscus-container mt-12">
  <script
    src="https://giscus.app/client.js"
    data-repo="iaurg/segredo-dev"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzODAzOTE4ODA="
    data-category="Announcements"
    data-category-id="DIC_kwDOFqxRyM4C1G4P"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async
  ></script>
</section>

<script is:inline data-astro-rerun>
  // Initialize Giscus with the correct theme based on current state
  // This script runs after the Giscus script element is in the DOM
  ;(() => {
    const isDark = document.documentElement.classList.contains('dark')
    const giscusScript = document.querySelector('script[src*="giscus.app/client.js"]')
    if (giscusScript) {
      giscusScript.setAttribute('data-theme', isDark ? 'dark' : 'light')
    }
  })()
</script>

<script>
  // Update giscus theme when the page theme changes
  document.addEventListener('astro:page-load', () => {
    const updateGiscusTheme = () => {
      const theme = document.documentElement.classList.contains('dark')
        ? 'dark'
        : 'light'

      const iframe = document.querySelector<HTMLIFrameElement>(
        'iframe.giscus-frame'
      )
      if (iframe) {
        iframe.contentWindow?.postMessage(
          { giscus: { setConfig: { theme } } },
          'https://giscus.app'
        )
      }
    }

    // Observe theme changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          updateGiscusTheme()
        }
      })
    })

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    })

    document.addEventListener(
      'astro:before-swap',
      () => {
        observer.disconnect()
      },
      { once: true }
    )

    // Ensure the initial theme state is synchronized with Giscus on page load
    updateGiscusTheme()
  })
</script>
