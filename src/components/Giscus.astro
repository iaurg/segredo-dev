---
// Giscus - A comments system powered by GitHub Discussions
// Configure at: https://giscus.app
---

<section class="giscus-container mt-12">
  <div class="giscus"></div>
</section>

<script>
  function loadGiscus() {
    const container = document.querySelector('.giscus-container .giscus')
    if (!container) return

    // Clear any existing giscus content
    container.innerHTML = ''

    // Remove any existing giscus script and iframe to allow reinitialization
    const existingScript = document.querySelector(
      'script[src*="giscus.app/client.js"]'
    )
    if (existingScript) {
      existingScript.remove()
    }
    const existingIframe = document.querySelector('iframe.giscus-frame')
    if (existingIframe) {
      existingIframe.remove()
    }

    // Determine current theme
    const theme = document.documentElement.classList.contains('dark')
      ? 'dark'
      : 'light'

    // Create and append the giscus script
    const script = document.createElement('script')
    script.src = 'https://giscus.app/client.js'
    script.setAttribute('data-repo', 'iaurg/segredo-dev')
    script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkzODAzOTE4ODA=')
    script.setAttribute('data-category', 'Announcements')
    script.setAttribute('data-category-id', 'DIC_kwDOFqxRyM4C1G4P')
    script.setAttribute('data-mapping', 'title')
    script.setAttribute('data-strict', '0')
    script.setAttribute('data-reactions-enabled', '1')
    script.setAttribute('data-emit-metadata', '0')
    script.setAttribute('data-input-position', 'bottom')
    script.setAttribute('data-theme', theme)
    script.setAttribute('data-lang', 'en')
    script.setAttribute('data-loading', 'lazy')
    script.crossOrigin = 'anonymous'
    script.async = true

    container.appendChild(script)

    // Setup theme observer for dynamic theme changes
    setupThemeObserver()
  }

  function setupThemeObserver() {
    const updateGiscusTheme = () => {
      const theme = document.documentElement.classList.contains('dark')
        ? 'dark'
        : 'light'

      const iframe = document.querySelector<HTMLIFrameElement>(
        'iframe.giscus-frame'
      )
      if (iframe) {
        iframe.contentWindow?.postMessage(
          { giscus: { setConfig: { theme } } },
          'https://giscus.app'
        )
      }
    }

    // Observe theme changes on the document element
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          updateGiscusTheme()
        }
      })
    })

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    })

    // Clean up observer on page swap
    document.addEventListener(
      'astro:before-swap',
      () => {
        observer.disconnect()
      },
      { once: true }
    )
  }

  document.addEventListener('astro:page-load', loadGiscus)
</script>
